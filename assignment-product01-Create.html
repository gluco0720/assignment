<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品建檔</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/myall.css">
</head>
<body>
    <section>
        <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
          <div class="container">
              <a class="navbar-brand" href="#">
                  <i class="fa-solid fa-plane fa-2x text-info wow animate__rotateIn" data-wow-duration="2s" data-wow-delay="0s" data-wow-iteration="infinite"></i>
              </a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                  data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                  aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarSupportedContent">
                  <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                      <li class="nav-item">
                          <a class="nav-link active h5" aria-current="page" href="assignment_furniture.html">首頁</a>
                      </li>
                      <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle ms-auto" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            高級功能
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item " target="_self" href="assignment-product01-Create.html" id="s02_member_btn01">商品建檔</a></li>
                            <li><a class="dropdown-item " target="_self" href="assignment-product01-Read.html" id="s02_member_btn02">商品瀏覽</a></li>
                            <li><a class="dropdown-item " target="_self" href="member-control_panel.html" id="s02_member_btn03">會員管理</a></li>
                        </ul>
                    </li>
                    </ul>
                  <div>
                    <span class="text-warning h3" id="user_message"></span>
                      <button class="btn btn-danger d-none ms-3 mb-2" id="s02_logout_btn">登出</button>
                  </div>
                  
              </div>
          </div>
      </nav>
      </section>
    <div class="container">
        <div class="row justify-content-center py-5">
            <div class="col-md-10 p-3 rounded-3 shadow-lg border border-2 border-dark">
                <div class="mb-3 form-floating">
                    <input type="text" class="form-control " placeholder="" id="pname" name="pname" list="myoptions">
                    <label for="">商品名稱</label>
                    <datalist id="myoptions">
                        <option value="拿鐵"></option>
                        <option value="珍奶"></option>
                        <option value="果汁"></option>
                    </datalist> 
                    <div class="valid-feedback">字數符合規定</div>
                    <div class="invalid-feedback">字數不符合規定</div>
                </div>
                <div class="mb-3">
                    <label for="price" class="form-label">價格(NT)</label>
                    <input type="number" min="0" max="50000" value="50" class="form-control"
                    id="price" name="price">
                    <div class="valid-feedback">價格符合(1-50000)</div>
                    <div class="invalid-feedback">價格未符合(1-50000)</div>
                </div>
                <div class="mb-3">
                    <label for="num01">數量:<span class="h5 text-danger" id="num01_text">5</span></label>
                    <input type="range" class="form-range" value="5" min="1" max="10" step="1" id="num01" name="num01">
                </div>
                <div class="form-check form-switch">
                    <input type="checkbox" name="switch01" id="switch01" class="form-check-input">
                    <label for="switch01" class="form-check-label">不需要運送</label>
                </div>
                <div class="my-3">
                    <div class="form-check form-check-inline">
                        <input type="checkbox" class="form-check-input" id="chk01" name="chk" value="會員限定">
                        <label for="chk01" class="form-check-label">會員限定</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="checkbox" class="form-check-input" id="chk02" name="chk" value="周年慶限定">
                        <label for="chk02" class="form-check-label">周年慶限定</label>
                    </div><div class="form-check form-check-inline">
                        <input type="checkbox" class="form-check-input" id="chk03" name="chk" value="優惠商品">
                        <label for="chk03" class="form-check-label">優惠商品</label>
                    
                </div>
                <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" id="radio01" name="rad" value="刷卡" checked>
                        <label for="radio01" class="form-check-label">刷卡</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" id="radio02" name="rad" value="linepay">
                        <label for="radio02" class="form-check-label">linepay</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" id="radio03" name="rad" value="現金">
                        <label for="radio03" class="form-check-label">現金</label>
                    </div>
                </div>
                <div class="row justify-content-start">
                    <div class="col-8">
                      <div class="my-3">
                        <label for="fileupload" class="form-label">檔案上傳</label>
                        <input
                          type="file"
                          class="form-control"
                          id="fileupload"
                          name="fileupload"
                        />
                        <img src="#" id="prevImg" alt="" class="w-50 mt-3 d-none" />
                      </div>
                      <button class="btn btn-success" id="ok_btn1">上傳</button>
                    </div>
                  </div>
                <div class="text-end">
                    <button class="btn btn-info" id="ok_btn2">確認</button>
                </div>
            </div>
         </div>
    </div>
    <div class="container">
        <div id="showmsg"></div>
    </div>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script>
        var switch01="不可以運送";//紀錄外送狀態
        var num01 =1;//記錄數量
        var flag_pname=false;
        var flag_price=true; //已經有價格的初始值要為true
        var flag_upload = false;
        var photo; //紀錄上傳照片的名字
          $(function(){
            //判斷是否登入
            if(getCookie("UID01")!=""){
              // UID存在，傳遞至後端api判斷否合法
              var dataJSON = {};
              dataJSON["UID01"]=getCookie("UID01");
              console.log(JSON.stringify(dataJSON));
              $.ajax({
                type:"POST",
                url:"member-Check_UID-.api.php",
                data:JSON.stringify(dataJSON),
                dataType:"json",
                success:showdata_Check_UID,
                error:function(){
                  alert("error-member-Check_UID-.api.php");
                }
              });
            }else{
                location.href="assignment_furniture.html";
            }
            // 登出按鈕監聽#s02_logout_btn
            $("#s02_logout_btn").click(function(){
              setCookie("UID01","",7);
              location.href="assignment_furniture.html";
            });
            //監聽_即時監聽 #price
            $("#price").bind("input propertychange",function(){
                console.log($(this).val());
                if($(this).val()>0 && $(this).val()<50001){
                    //價格符合規定
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_price=true;
                }else{
                    $(this).removeClass("is-valid");
                    $(this).addClass("is-invalid");
                    flag_price=false;
                }
            });
           
            // 監聽_即時監聽 #pname
            $("#pname").bind("input propertychange",function(){
                console.log($(this).val().length);
                if($(this).val().length > 0 && $(this).val().length <30){
                    //字數符合規定
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_pname=true;
                }else{
                    //字數不符合規定
                    $(this).removeClass("is-valid");
                    $(this).addClass("is-invalid");
                    flag_pname=false;
                }
            });

            // 監聽switch外送
            $("#switch01").change(function(){
                console.log($(this).is(':checked'));
                if($(this).is(':checked')){
                    $(this).next().text('可以運送!');
                    switch01='可以運送';
                }else{
                    $(this).next().text('不可以運送!');
                    switch01='不可以運送';
                }
            });

            //  監聽_即時監聽 range #num01
            $("#num01").bind("input propertychange",function(){
                 console.log($(this).val());
                 $("#num01_text").text($(this).val());
                 num01=$(this).val()
            });

            // $("#num01").change(function(){
            //     console.log($(this).val());
            // });
            // 按鈕監聽

            //資料庫上傳
            $("#ok_btn2").click(function(){
                if(flag_pname && flag_price){
                console.log($("#pname").val());
                console.log($("#price").val());
                
                // 收集checkbox加料區的資料
                // $.each($("input[name='chk']:checked"),function(){
                //     console.log($(this).val());
                // });
                var chkArray=[];
                $.each($("input[name='chk']:checked"),function(){
                    console.log($(this).val());
                    chkArray.push($(this).val());
                });
                if(chkArray.length == 0){
                    chkArray.push("不加料");
                }
                console.log(chkArray);
                var rad_pay;//付款方式的資料
                $.each($("input[name='rad']:checked"),function(){
                    console.log($(this).val());
                    rad_pay=$(this).val();
                });


                $("#showmsg").html("<h1>商品名稱:"+$("#pname").val() + "</h1><h1>價格(NT):"+$("#price").val()+"</h1><h1>冰度:"+$("#ice").val()+"</h1><h1>數量:"+num01+"</h1><h1>運送:"+switch01+"</h1><h1>加料:"+chkArray.join("/")+"</h1><h1>總價:"+$("#price").val()*num01+"元</h1><h1>付款方式:"+rad_pay+"</h1>");
                //將傳遞至後端api參數 轉換成json格式
                //{"Pname":"奶茶", "Price":"50", "Sugar":"全糖", "Num":"10", "Delivery":"true", "Added":"珍珠","Pay":"刷卡","Total":"500"}
                var dataJSON ={};
                dataJSON["Pname"]=$("#pname").val();
                dataJSON["Price"]=$("#price").val();
                dataJSON["Num"]=num01;
                dataJSON["Delivery"]=switch01;
                dataJSON["Added"]=chkArray.join("/");
                dataJSON["Pay"]=rad_pay;
                dataJSON["Total"]=$("#price").val()*num01;            

                console.log(JSON.stringify(dataJSON));

                $.ajax({
                    type:"POST",
                    url:"assignment-product01-Create-api.php",
                    data:JSON.stringify(dataJSON),
                    contentType:"application/json;charset=utf-8",
                    dataType:"json",
                    success:showdata2,
                    error:function(){
                        alert("error~assignment-product01-Create-api.php");
                    }
                });

            }else{
                alert("欄位有誤，請修正!");
            }
            });
        });
        function showdata2(data){
            if(data.state){
                console.log("資料庫");
            console.log(data);
            // alert("資料上傳成功");
            var dataJSON ={};

                dataJSON["id"]=data.data[0].id;
                dataJSON["photo"]=photo;       

                console.log(JSON.stringify(dataJSON));

                $.ajax({
                    type:"POST",
                    url:"assignment-product01-Edit-photoId-api.php",
                    data:JSON.stringify(dataJSON),
                    contentType:"application/json;charset=utf-8",
                    dataType:"json",
                    success:showdata3,
                    error:function(){
                        alert("error~assignment-product01-Edit-photoId-api.php");
                    }});
            // location.href="assignment-product01-Create.html";
            }else{
            alert(data.message);    
            }
        }
        function showdata_Check_UID(data){
            console.log(data);
            if(data.state){
                //驗證成功
                $("#user_message").text(data.data[0].Username + "登入中!");
            
                // 顯示登出按鈕
                $("#s02_logout_btn").removeClass("d-none");
            }else{
                location.href="assignment_furniture.html";
            }
        }
        // w3s
        function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
        let expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
         }
        // W3S
      function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == " ") {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }
      $(function () {
        $("#fileupload").change(function () {
          console.log(fileupload);
          console.log(fileupload.files[0]);
          console.log(fileupload.files[0].name);
          console.log(fileupload.files[0].size);
          console.log(fileupload.files[0].type);
          // 圖片於瀏覽器的暫存路徑
          console.log(URL.createObjectURL(fileupload.files[0]));

          if (
            fileupload.files[0].type == "image/jpeg" ||
            fileupload.files[0].type == "image/png"
          ) {
            // 顯示預覽圖
            $("#prevImg").removeClass("d-none");
            $("#prevImg").attr("src", URL.createObjectURL(fileupload.files[0]));
            flag_upload = true;
          } else {
            console.log("圖片格式不符合!");
            flag_upload = false;
            alert("圖片格式不符合");
          }
        });

        //照片上傳
        $("#ok_btn1").click(function () {
          if (flag_upload) {
            var formdata = new FormData();
            formdata.append("file", fileupload.files[0]);
            console.log(fileupload.files[0]);
            console.log(formdata);
            //傳遞formdata至後端api
            $.ajax({
                type: "POST",
                url: "assignment-product01-Create-photo-practice.php",
                data: formdata,
                dataType: "json",
                cache: false,
                contentType: false,
                processData: false,
                success: showdata1,
                error: function(){
                    alert("error-assignment-product01-Create-photo-practice.php");
                }
            });
          } else {
            alert("先選取上傳圖片");
          }
        });
      });
      function showdata1(data) {
        console.log(data);
        photo = data.data.serverfilename;
        console.log(photo);
        alert("照片上傳成功");
        // location.href="assignment-product01-Create.html";
        }
        function showdata3(data) {
        console.log(data);
        alert("上傳成功");
        location.href="assignment-product01-Create.html";
        }
    </script>
</body>
</html>