<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>商品瀏覽</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/myall.css" />
  </head>
  <body>
    <section>
      <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
        <div class="container">
          <a class="navbar-brand" href="#">
            <i
              class="fa-solid fa-plane fa-2x text-info wow animate__rotateIn"
              data-wow-duration="2s"
              data-wow-delay="0s"
              data-wow-iteration="infinite"
            ></i>
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a
                  class="nav-link active h5"
                  aria-current="page"
                  href="assignment_furniture.html"
                  >首頁</a
                >
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle ms-auto"
                  href="#"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  高級功能
                </a>
                <ul class="dropdown-menu">
                  <li>
                    <a
                      class="dropdown-item disabled"
                      target="_self"
                      href="assignment-product01-Create.html"
                      id="s02_member_btn01"
                      >商品建檔</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item"
                      target="_self"
                      href="assignment-product01-Read.html"
                      id="s02_member_btn02"
                      >商品瀏覽</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item disabled"
                      target="_self"
                      href="member-control_panel.html"
                      id="s02_member_btn03"
                      >會員管理</a
                    >
                  </li>
                </ul>
              </li>
            </ul>
            <div>
              <span class="text-warning h3" id="user_message"></span>
              <button
                class="btn btn-danger d-none ms-3 mb-2"
                id="s02_logout_btn"
              >
                登出
              </button>
            </div>
          </div>
        </div>
      </nav>
    </section>
    <div class="container py-5">
      <table
        class="table table-bordered table-striped table-hover table-sm border-success table-rwd"
      >
        <caption class="text-end">
          商品列表
        </caption>
        <thead class="table-dark">
          <tr>
            <th width="10%">商品編號</th>
            <th width="10%">產品名稱</th>
            <th width="15%">產品圖片</th>
            <th width="10%">產品價格</th>
            <th width="10%">產品數量</th>
            <th width="10%">是否運送</th>
            <th>產品優惠</th>
            <th>付款方式</th>
            <th>總價</th>
            <th>產品建檔時間</th>
            <th class="d-none" id="btn01">更新/刪除</th>
          </tr>
        </thead>
        <tbody id="mydata">
          <tr>
            <td>商品編號</td>
            <td>產品名稱</td>
            <td>
              <img
                src="/assignment/upload/產品圖片"
                alt=""
                style="height: 150px; width: 150px"
              />
            </td>
            <td>產品價格</td>
            <td>產品數量</td>
            <td>是否運送</td>
            <td>產品優惠</td>
            <td>付款方式</td>
            <td>總價</td>
            <td>產品建檔時間</td>
            <td>
              <button class="btn btn-success">更新</button>
              <button class="btn btn-danger">刪除</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- updateModal -->
    <div
      class="modal fade"
      id="updateModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">產品更新</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="pname" class="form-label">產品名稱</label>
              <input type="text" class="form-control" id="pname" name="pname" />
              <div class="valid-feedback">字數符合規定</div>
              <div class="invalid-feedback">字數不符合規定</div>
            </div>
            <!-- <div class="mb-3">
              <label for="photo" class="form-label">產品圖片</label>
              <input type="file" class="form-control" id="photo" name="photo" />
              <div class="valid-feedback">圖片符合規定</div>
              <div class="invalid-feedback">圖片不符合規定</div>
            </div> -->
            <div class="mb-3">
              <label for="price" class="form-label">產品價格</label>
              <input
                type="number"
                class="form-control"
                id="price"
                name="price"
                min="0"
                max="100"
              />
              <div class="valid-feedback">價格符合規定(1-100)</div>
              <div class="invalid-feedback">價格不符合規定(1-100)</div>
            </div>
            <div class="mb-3">
              <label for="num" class="form-label">產品數量</label>
              <input type="text" class="form-control" id="num" name="num" />
              <div class="valid-feedback">字數符合規定</div>
              <div class="invalid-feedback">字數不符合規定</div>
            </div>
            <div class="mb-3">
              <label for="delivery" class="form-label">是否運送</label>
              <input
                type="text"
                class="form-control"
                id="delivery"
                name="delivery"
              />
              <div class="valid-feedback">字數符合規定</div>
              <div class="invalid-feedback">字數不符合規定</div>
            </div>
            <div class="mb-3">
              <label for="added" class="form-label">產品優惠</label>
              <input type="text" class="form-control" id="added" name="added" />
              <div class="valid-feedback">字數符合規定</div>
              <div class="invalid-feedback">字數不符合規定</div>
            </div>
            <div class="mb-3">
              <label for="pay" class="form-label">付款方式 </label>
              <input type="text" class="form-control" id="pay" name="pay" />
              <div class="valid-feedback">字數符合規定</div>
              <div class="invalid-feedback">字數不符合規定</div>
            </div>
            <div class="mb-3">
              <label for="total" class="form-label">總價</label>
              <input type="text" class="form-control" id="total" name="total" />
              <div class="valid-feedback">字數符合規定</div>
              <div class="invalid-feedback">字數不符合規定</div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              取消
            </button>
            <button type="button" class="btn btn-primary" id="modal_update_btn">
              確認更新
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script>
      var u_id; //update id
      var flag_upload = false;
      $(function () {
        //判斷是否登入
        if (getCookie("UID01") != "") {
          // UID存在，傳遞至後端api判斷否合法
          var dataJSON = {};
          dataJSON["UID01"] = getCookie("UID01");
          console.log(JSON.stringify(dataJSON));
          $.ajax({
            type: "POST",
            url: "member-Check_UID-.api.php",
            data: JSON.stringify(dataJSON),
            dataType: "json",
            success: showdata_Check_UID,
            error: function () {
              alert("error-member-Check_UID-.api.php");
            },
          });
        } else {
          location.href = "assignment_furniture.html";
        }
        // 登出按鈕監聽#s02_logout_btn
        $("#s02_logout_btn").click(function () {
          setCookie("UID01", "", 7);
          location.href = "assignment_furniture.html";
        });

        $.ajax({
          type: "GET",
          url: "assignment-product01-Read-api.php",
          dataType: "json",
          async: false,
          success: showdata,
          error: function () {
            alert("error~assignment-product01-Read-api.php");
          },
        });
        //監聽#update_btn
        $("#mydata #update_btn").click(function () {
          console.log("update_btn_ok");
          console.log($(this).data("id"));
          console.log($(this).data("pname"));
          console.log($(this).data("price"));
          console.log($(this).data("num"));
          console.log($(this).data("delivery"));
          console.log($(this).data("added"));
          console.log($(this).data("pay"));
          console.log($(this).data("total"));

          u_id = $(this).data("id");
          $("#pname").val($(this).data("pname"));
          $("#price").val($(this).data("price"));
          $("#num").val($(this).data("num"));
          $("#delivery").val($(this).data("delivery"));
          $("#added").val($(this).data("added"));
          $("#pay").val($(this).data("pay"));
          $("#total").val($(this).data("total"));
        });
        //監聽#delete_btn
        $("#mydata #delete_btn").click(function () {
          if (confirm("確認刪除此筆資料嗎>")) {
            console.log($(this).data("id"));
            //產生json格式的參數
            var dataJSON = {};
            dataJSON["ID"] = $(this).data("id");
            console.log(JSON.stringify(dataJSON));
            //傳遞參數至後端api執行功能
            $.ajax({
              type: "POST",
              url: "assignment-product01-Delete-api.php",
              data: JSON.stringify(dataJSON),
              dataType: "json",
              success: showdata_delete,
              error: function () {
                alert("error~assignment-product01-Delete-api.php");
              },
            });
          }
        });
        //監聽 #modal_update_btn
        $("#modal_update_btn").click(function () {
          //產生json格式的變數
          var dataJSON = {};
          dataJSON["ID"] = u_id;
          dataJSON["Pname"] = $("#pname").val();
          dataJSON["Price"] = $("#price").val();
          dataJSON["Photo"] = $("#photo").val();
          dataJSON["Num"] = $("#num").val();
          dataJSON["Delivery"] = $("#delivery").val();
          dataJSON["Added"] = $("#added").val();
          dataJSON["Pay"] = $("#pay").val();
          dataJSON["Total"] = $("#total").val();

          console.log(JSON.stringify(dataJSON));
          //傳遞更新參數至後端api
          $.ajax({
            type: "POST",
            url: "assignment-product01-Update-api.php",
            data: JSON.stringify(dataJSON),
            dataType: "json",
            success: showdata_updata,
            error: function () {
              alert("error-assignment-product01-Update-api.php");
            },
          });
        });
      });
      function showdata(data) {
        console.log(data);

        $("#mydata").empty();
        data.data.forEach(function (item) {
          console.log(item.Pname);
          var strHTML =
            "<tr><td>" +
            item.ID +
            "</td><td>" +
            item.Pname +
            "</td><td><img src='/assignment/upload/" +
            item.photo +
            "' style='height: 100px; width: auto;'></td><td>" +
            item.Price +
            "</td><td>" +
            item.Num +
            "</td><td>" +
            item.Delivery +
            "</td><td>" +
            item.Added +
            "</td><td>" +
            item.Pay +
            "</td><td>" +
            item.Total +
            "</td><td>" +
            item.Created_at +
            '</td><td class="d-none" id="btn02"><button class="btn btn-success me-1" data-bs-toggle="modal" data-bs-target="#updateModal" data-id="' +
            item.ID +
            '" data-pname="' +
            item.Pname +
            '" data-price="' +
            item.Photo +
            '" data-photo="' +
            item.Sugar +
            '" data-num="' +
            item.Num +
            '" data-delivery="' +
            item.Delivery +
            '" data-added="' +
            item.Added +
            '" data-pay="' +
            item.Pay +
            '" data-total="' +
            item.Total +
            '" id="update_btn">更新</button><button class="btn btn-danger" data-id="' +
            item.ID +
            '" id="delete_btn">刪除</button></td></tr>';
          $("#mydata").append(strHTML);
        });
      }

      function showdata_updata(data) {
        console.log(data);
        if (data.state) {
          alert(data.message);
          location.href = "assignment-product01-Read.html";
        } else {
          alert(data.message);
        }
      }
      function showdata_delete(data) {
        console.log(data);
        if (data.state) {
          alert(data.message);
          location.href = "assignment-product01-Read.html";
        } else {
          alert(data.message);
        }
      }
      function showdata_Check_UID(data) {
        console.log(data);
        if (data.state) {
          //驗證成功
          $("#user_message").text(data.data[0].Username + "登入中!");

          // 顯示登出按鈕
          $("#s02_logout_btn").removeClass("d-none");

          if (data.data[0].Level == 1) {
            console.log(data.data[0].Level);
            $("#btn01").removeClass("d-none");
            $("#s02_member_btn01").removeClass("disabled");
            $("#s02_member_btn03").removeClass("disabled");
            $("#mydata #btn02").removeClass("d-none");
          }
        } else {
          location.href = "assignment_furniture.html";
        }
      }
      // w3s
      function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
        let expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
      }
      // W3S
      function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == " ") {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }
    </script>
  </body>
</html>
